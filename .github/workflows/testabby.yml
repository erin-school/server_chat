name: Abyss Alert

on:
  schedule:
    # 매분 실행 (2분 전 감지용)
    - cron: "*/1 * * * *"
  workflow_dispatch:  # 수동 실행도 가능

jobs:
  abyss:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Abyss spawn alert (auto + manual)
        env:
          TZ: "Asia/Seoul"
        run: |
          echo "현재 시간 (KST): $(date)"

          # times.json 확인
          if [ ! -f "times.json" ]; then
            echo "⚠️ times.json 파일이 없음 — 기본 데이터 생성"
            echo '["2025-11-04T00:54:00+09:00","2025-11-05T13:09:00+09:00","2025-11-07T01:24:00+09:00","2025-11-08T13:39:00+09:00","2025-11-10T01:54:00+09:00","2025-11-11T14:09:00+09:00"]' > times.json
          fi

          NOW=$(date '+%s')
          CLOSEST_DIFF=9999999999
          CLOSEST_TIME=""

          # times.json 순회
          while read LINE; do
            TIME=$(echo $LINE | grep -oE '"[0-9T:+-]+"' | tr -d '"')
            [ -z "$TIME" ] && continue

            TARGET=$(date -d "$TIME" '+%s')
            ALERT=$((TARGET - 120)) # 2분 전
            DIFF=$((NOW - ALERT))

            # 🔔 자동 알림 (2분 전 감지)
            if [ $DIFF -ge 0 ] && [ $DIFF -lt 60 ]; then
              echo "🔔 어비스 구멍 출현 알림 전송!"
              curl -H "Content-Type: application/json" \
                   -X POST \
                   -d "{\"content\":\"🌌 어비스 구멍 출현이야!\"}" \
                   ${{ secrets.DISCORD_WEBHOOK_URL }}
            fi

            # 📅 수동 실행용 다음 출현 시간 계산
            FUTURE_DIFF=$((TARGET - NOW))
            if [ $FUTURE_DIFF -ge 0 ] && [ $FUTURE_DIFF -lt $CLOSEST_DIFF ]; then
              CLOSEST_DIFF=$FUTURE_DIFF
              CLOSEST_TIME=$TIME
            fi
          done < <(cat times.json)

          # 🧩 수동 실행 시 다음 어비스 시간 전송
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "$CLOSEST_TIME" ]; then
              WEEKDAY=$(date -d "$CLOSEST_TIME" '+%u')
              case $WEEKDAY in
                1) DAY="월";;
                2) DAY="화";;
                3) DAY="수";;
                4) DAY="목";;
                5) DAY="금";;
                6) DAY="토";;
                7) DAY="일";;
              esac

              KST_FORMAT=$(date -d "$CLOSEST_TIME" '+%Y년 %m월 %d일')
              HOUR_MIN=$(date -d "$CLOSEST_TIME" '+%p %I시 %M분' | sed 's/AM/오전/;s/PM/오후/')
              MESSAGE="📅 다음 어비스 예상 출현: ${KST_FORMAT} (${DAY}요일) ${HOUR_MIN}"

              echo "$MESSAGE"
              curl -H "Content-Type: application/json" \
                   -X POST \
                   -d "{\"content\":\"$MESSAGE\"}" \
                   ${{ secrets.DISCORD_WEBHOOK_URL }}
            else
              echo "❌ 다음 출현 시간이 없음."
              curl -H "Content-Type: application/json" \
                   -X POST \
                   -d "{\"content\":\"❌ 다음 어비스 출현 시간이 없습니다.\"}" \
                   ${{ secrets.DISCORD_WEBHOOK_URL }}
            fi
          fi
