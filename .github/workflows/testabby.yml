name: Abyss Alert (Embed)

on:
schedule:
# Îß§Î∂Ñ Ïã§Ìñâ (2Î∂Ñ Ï†Ñ Í∞êÏßÄÏö©)
- cron: "*/1 * * * *"
workflow_dispatch:  # ÏàòÎèô Ïã§Ìñâ Í∞ÄÎä•

jobs:
abyss:
runs-on: ubuntu-latest
steps:
- name: Checkout repository
uses: actions/checkout@v4

- name: Abyss spawn alert (Embed)  
    env:  
      TZ: "Asia/Seoul"  
    run: |  
      KST_HOUR=$(date '+%H')  
      KST_MINUTE=$(date '+%M')  
      NOW_KST=$(date '+%Y-%m-%d %H:%M:%S')  
      NOW=$(date '+%s')  
      echo "ÌòÑÏû¨ ÏãúÍ∞Ñ (KST): ${NOW_KST}"  

      # times.json ÌôïÏù∏  
      if [ ! -f "times.json" ]; then  
        echo "‚ö†Ô∏è times.json ÌååÏùºÏù¥ ÏóÜÏùå ‚Äî Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±"  
        echo '["2025-11-04T00:54:00+09:00","2025-11-05T13:09:00+09:00","2025-11-07T01:24:00+09:00","2025-11-08T13:39:00+09:00","2025-11-10T01:54:00+09:00","2025-11-11T14:09:00+09:00"]' > times.json  
      fi  

      # Ï§ëÎ≥µ Î∞úÏÜ° Í∏∞Î°ù ÌååÏùº  
      LAST_SENT_FILE="last_sent.txt"  
      if [ ! -f "$LAST_SENT_FILE" ]; then  
        echo "" > "$LAST_SENT_FILE"  
      fi  
      LAST_SENT=$(cat "$LAST_SENT_FILE")  

      CLOSEST_DIFF=9999999999  
      CLOSEST_TIME=""  

      while read LINE; do  
        TIME=$(echo $LINE | grep -oE '"[0-9T:+-]+"' | tr -d '"')  
        [ -z "$TIME" ] && continue  

        TARGET=$(date -d "$TIME" '+%s')  
        ALERT=$((TARGET - 120)) # 2Î∂Ñ Ï†Ñ  
        DIFF=$((NOW - ALERT))  

        # üîî ÏûêÎèô ÏïåÎ¶º (2Î∂Ñ Ï†Ñ ~ Ï∂úÌòÑ ÏãúÏ†êÍπåÏßÄ, ÏàòÎ©¥ ÏãúÍ∞Ñ Ï†úÏô∏, Ï§ëÎ≥µ Î∞©ÏßÄ)  
        if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then  
          if [ "$KST_HOUR" -ge 23 ] || [ "$KST_HOUR" -lt 8 ]; then  
            echo "üí§ ÏàòÎ©¥ ÏãúÍ∞Ñ: ÏûêÎèô ÏïåÎ¶º ÏÉùÎûµ (${KST_HOUR}:${KST_MINUTE})"  
          elif [ $DIFF -ge 0 ] && [ $DIFF -lt 120 ] && [ "$LAST_SENT" != "$TIME" ]; then  
            echo "üîî Ïñ¥ÎπÑÏä§ Ï∂úÌòÑ ÏïåÎ¶º Î∞úÏÜ°: $TIME"  

            MESSAGE="ÏóêÎ¶∞ ÏÑ∏Í≥ÑÏóê Ïñ¥ÎπÑÏä§Î°ú Ìñ•ÌïòÎäî Íµ¨Î©çÏù¥ Ï∂úÌòÑÌñàÏäµÎãàÎã§! Îπ®Î¶¨Í∞ÄÏÑú Í≥®ÎìúÎ•º ÏñªÏúºÏÑ∏Ïöî."  
            EMBED_TITLE="üåå Ïñ¥ÎπÑÏä§ Íµ¨Î©ç Ï∂úÌòÑ!"  
            EMBED_COLOR=1127128  

            PAYLOAD=$(jq -n \  
              --arg content "$MESSAGE" \  
              --arg title "$EMBED_TITLE" \  
              --arg description "ÏûêÎèô ÏïåÎ¶º: $(date -d "@$NOW" '+%Y-%m-%d %H:%M:%S')" \  
              --argjson color "$EMBED_COLOR" \  
              --arg footer "ÏàòÎ©¥ ÏãúÍ∞Ñ(23Ïãú~8Ïãú)ÏóêÎäî Î∞úÏÜ°ÎêòÏßÄ ÏïäÏäµÎãàÎã§." \  
              '{  
                content: $content,  
                embeds: [  
                  {  
                    title: $title,  
                    description: $description,  
                    color: $color,  
                    footer: {text: $footer}  
                  }  
                ]  
              }')  

            curl -H "Content-Type: application/json" \  
                 -X POST \  
                 -d "$PAYLOAD" \  
                 ${{ secrets.DISCORD_WEBHOOK_URL }}  

            # Î∞úÏÜ° Í∏∞Î°ù Í∞±Ïã†  
            echo "$TIME" > "$LAST_SENT_FILE"  
          fi  
        fi  

        # Îã§Ïùå Ï∂úÌòÑ ÏãúÍ∞Ñ Í≥ÑÏÇ∞  
        FUTURE_DIFF=$((TARGET - NOW))  
        if [ $FUTURE_DIFF -ge 0 ] && [ $FUTURE_DIFF -lt $CLOSEST_DIFF ]; then  
          CLOSEST_DIFF=$FUTURE_DIFF  
          CLOSEST_TIME=$TIME  
        fi  
      done < <(cat times.json)  

      # üß© ÏàòÎèô Ïã§Ìñâ Ïãú Îã§Ïùå Ïñ¥ÎπÑÏä§ ÏãúÍ∞Ñ Embed Ï†ÑÏÜ° (ÏãúÍ∞Ñ Ï†úÌïú ÏóÜÏùå)  
      if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then  
        if [ -n "$CLOSEST_TIME" ]; then  
          WEEKDAY=$(date -d "$CLOSEST_TIME" '+%u')  
          case $WEEKDAY in  
            1) DAY="Ïõî";;  
            2) DAY="Ìôî";;  
            3) DAY="Ïàò";;  
            4) DAY="Î™©";;  
            5) DAY="Í∏à";;  
            6) DAY="ÌÜ†";;  
            7) DAY="Ïùº";;  
          esac  

          KST_FORMAT=$(date -d "$CLOSEST_TIME" '+%YÎÖÑ %mÏõî %dÏùº')  
          HOUR_MIN=$(date -d "$CLOSEST_TIME" '+%p %IÏãú %MÎ∂Ñ' | sed 's/AM/Ïò§Ï†Ñ/;s/PM/Ïò§ÌõÑ/')  
          MESSAGE="üìÖ Îã§Ïùå Ïñ¥ÎπÑÏä§ Ï∂úÌòÑ ÏãúÍ∞Ñ"  
          EMBED_TITLE="${KST_FORMAT} (${DAY}ÏöîÏùº) ${HOUR_MIN}"  
          EMBED_COLOR=14177041  

          PAYLOAD=$(jq -n \  
            --arg content "$MESSAGE" \  
            --arg title "$EMBED_TITLE" \  
            --arg description "ÏµúÏ¢Ö ÌôïÏù∏ ÏãúÍ∞Ñ: ${NOW_KST}" \  
            --argjson color "$EMBED_COLOR" \  
            --arg footer "ÏóÖÎç∞Ïù¥Ìä∏ ÏùºÏ†ïÏóê Îî∞Îùº Ï∂úÌòÑ ÏãúÍ∞ÑÏù¥ Î≥ÄÍ≤Ω Îê† Ïàò ÏûàÏäµÎãàÎã§." \  
            '{  
              content: $content,  
              embeds: [  
                {  
                  title: $title,  
                  description: $description,  
                  color: $color,  
                  footer: {text: $footer}  
                }  
              ]  
            }')  

          curl -H "Content-Type: application/json" \  
               -X POST \  
               -d "$PAYLOAD" \  
               ${{ secrets.DISCORD_WEBHOOK_URL }}  
        else  
          MESSAGE="‚ùå Îã§Ïùå Ï∂úÌòÑ ÏãúÍ∞ÑÏù¥ ÏóÜÏùå."  
          EMBED_TITLE="Ïñ¥ÎπÑÏä§ Ï†ïÎ≥¥ ÏóÜÏùå"  
          EMBED_COLOR=7506394  

          PAYLOAD=$(jq -n \  
            --arg content "$MESSAGE" \  
            --arg title "$EMBED_TITLE" \  
            --arg description "ÏàòÎèô ÌôïÏù∏ ÏãúÍ∞Å: ${NOW_KST}" \  
            --argjson color "$EMBED_COLOR" \  
            --arg footer "Ï∂îÏñµ Í∏∏Îìú" \  
            '{  
              content: $content,  
              embeds: [  
                {  
                  title: $title,  
                  description: $description,  
                  color: $color,  
                  footer: {text: $footer}  
                }  
              ]  
            }')  

          curl -H "Content-Type: application/json" \  
               -X POST \  
               -d "$PAYLOAD" \  
               ${{ secrets.DISCORD_WEBHOOK_URL }}  
        fi  
      fi
