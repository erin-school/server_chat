name: Test Abyss Alert

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ì „ìš©

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test Abyss spawn alert
        run: |
          echo "í˜„ì¬ ì‹œê°„ (KST): $(date -d '+9 hours')"
          
          # times.json íŒŒì¼ ì¡´ì¬ í™•ì¸
          if [ ! -f "times.json" ]; then
            echo "âš ï¸ times.json íŒŒì¼ì´ ì—†ìŒ â€” í…ŒìŠ¤íŠ¸ìš© ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©"
            echo '["2025-11-04T00:54:00+09:00"]' > times.json
          fi

          NOW=$(date -d '+9 hours' '+%s')

          while read LINE; do
            TIME=$(echo $LINE | grep -oE '"[0-9T:+-]+"' | tr -d '"')
            [ -z "$TIME" ] && continue
            TARGET=$(date -d "$TIME" '+%s')
            ALERT=$((TARGET - 120)) # 2ë¶„ ì „
            DIFF=$((NOW - ALERT))

            echo "í˜„ì¬($NOW) vs ì•Œë¦¼ ì‹œê°($ALERT)"
            if [ $DIFF -ge 0 ] && [ $DIFF -lt 300 ]; then
              echo "ğŸ”” í…ŒìŠ¤íŠ¸ìš© ì–´ë¹„ìŠ¤ ì•Œë¦¼ ì „ì†¡!"
              curl -H "Content-Type: application/json" \
                   -X POST \
                   -d "{\"content\":\"ğŸŒŒ ì–´ë¹„ìŠ¤ êµ¬ë© ì¶œí˜„ì´ì•¼! (í…ŒìŠ¤íŠ¸ ì „ì†¡)\"}" \
                   ${{ secrets.DISCORD_WEBHOOK_URL }}
            else
              echo "â³ ì•„ì§ ì•Œë¦¼ ì‹œì ì´ ì•„ë‹˜ (ì°¨ì´: ${DIFF}s)"
            fi
          done < <(cat times.json)
