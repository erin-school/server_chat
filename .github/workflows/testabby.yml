name: Abyss Alert (Embed)

on:
  schedule:
    # ë§¤ë¶„ ì‹¤í–‰ (2ë¶„ ì „ ê°ì§€ìš©)
    - cron: "*/1 * * * *"
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  abyss:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Abyss spawn alert (Embed)
        env:
          TZ: "Asia/Seoul"
        run: |
          KST_HOUR=$(date '+%H')
          KST_MINUTE=$(date '+%M')
          NOW_KST=$(date '+%Y-%m-%d %H:%M:%S')
          echo "í˜„ì¬ ì‹œê°„ (KST): ${NOW_KST}"

          # times.json í™•ì¸
          if [ ! -f "times.json" ]; then
            echo "âš ï¸ times.json íŒŒì¼ì´ ì—†ìŒ â€” ê¸°ë³¸ ë°ì´í„° ìƒì„±"
            echo '["2025-11-04T00:54:00+09:00","2025-11-05T13:09:00+09:00","2025-11-07T01:24:00+09:00","2025-11-08T13:39:00+09:00","2025-11-10T01:54:00+09:00","2025-11-11T14:09:00+09:00"]' > times.json
          fi

          NOW=$(date '+%s')
          CLOSEST_DIFF=9999999999
          CLOSEST_TIME=""

          while read LINE; do
            TIME=$(echo $LINE | grep -oE '"[0-9T:+-]+"' | tr -d '"')
            [ -z "$TIME" ] && continue

            TARGET=$(date -d "$TIME" '+%s')
            ALERT=$((TARGET - 120)) # 2ë¶„ ì „
            DIFF=$((NOW - ALERT))

            # ğŸ”” ìë™ ì•Œë¦¼ (2ë¶„ ì „ ê°ì§€, ìˆ˜ë©´ ì‹œê°„ ì œì™¸)
            if [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
              if [ "$KST_HOUR" -ge 23 ] || [ "$KST_HOUR" -lt 8 ]; then
                echo "ğŸ’¤ ìˆ˜ë©´ ì‹œê°„: ìë™ ì•Œë¦¼ ìƒëµ (${KST_HOUR}:${KST_MINUTE})"
              elif [ $DIFF -ge 0 ] && [ $DIFF -lt 60 ]; then
                MESSAGE="ì—ë¦° ì„¸ê³„ì— ì–´ë¹„ìŠ¤ë¡œ í–¥í•˜ëŠ” êµ¬ë©ì´ ì¶œí˜„í–ˆìŠµë‹ˆë‹¤! ë¹¨ë¦¬ê°€ì„œ ê³¨ë“œë¥¼ ì–»ìœ¼ì„¸ìš”."
                EMBED_TITLE="ğŸŒŒ ì–´ë¹„ìŠ¤ êµ¬ë© ì¶œí˜„!"
                EMBED_COLOR=1127128

                PAYLOAD=$(jq -n \
                  --arg content "$MESSAGE" \
                  --arg title "$EMBED_TITLE" \
                  --arg description "ìë™ ì•Œë¦¼: $(date -d "@$NOW" '+%Y-%m-%d %H:%M:%S')" \
                  --argjson color "$EMBED_COLOR" \
                  --arg footer "ìˆ˜ë©´ ì‹œê°„(23ì‹œ~8ì‹œ)ì—ëŠ” ë°œì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤." \
                  '{
                    content: $content,
                    embeds: [
                      {
                        title: $title,
                        description: $description,
                        color: $color,
                        footer: {text: $footer}
                      }
                    ]
                  }')

                curl -H "Content-Type: application/json" \
                     -X POST \
                     -d "$PAYLOAD" \
                     ${{ secrets.DISCORD_WEBHOOK_URL }}
              fi
            fi

            # ë‹¤ìŒ ì¶œí˜„ ì‹œê°„ ê³„ì‚°
            FUTURE_DIFF=$((TARGET - NOW))
            if [ $FUTURE_DIFF -ge 0 ] && [ $FUTURE_DIFF -lt $CLOSEST_DIFF ]; then
              CLOSEST_DIFF=$FUTURE_DIFF
              CLOSEST_TIME=$TIME
            fi
          done < <(cat times.json)

          # ğŸ§© ìˆ˜ë™ ì‹¤í–‰ ì‹œ ë‹¤ìŒ ì–´ë¹„ìŠ¤ ì‹œê°„ Embed ì „ì†¡ (ì‹œê°„ ì œí•œ ì—†ìŒ)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ -n "$CLOSEST_TIME" ]; then
              WEEKDAY=$(date -d "$CLOSEST_TIME" '+%u')
              case $WEEKDAY in
                1) DAY="ì›”";;
                2) DAY="í™”";;
                3) DAY="ìˆ˜";;
                4) DAY="ëª©";;
                5) DAY="ê¸ˆ";;
                6) DAY="í† ";;
                7) DAY="ì¼";;
              esac

              KST_FORMAT=$(date -d "$CLOSEST_TIME" '+%Yë…„ %mì›” %dì¼')
              HOUR_MIN=$(date -d "$CLOSEST_TIME" '+%p %Iì‹œ %Më¶„' | sed 's/AM/ì˜¤ì „/;s/PM/ì˜¤í›„/')
              MESSAGE="ğŸ“… ë‹¤ìŒ ì–´ë¹„ìŠ¤ ì¶œí˜„ ì‹œê°„"
              EMBED_TITLE="${KST_FORMAT} (${DAY}ìš”ì¼) ${HOUR_MIN}"
              EMBED_COLOR=14177041

              PAYLOAD=$(jq -n \
                --arg content "$MESSAGE" \
                --arg title "$EMBED_TITLE" \
                --arg description "ìµœì¢… í™•ì¸ ì‹œê°„: ${NOW_KST}" \
                --argjson color "$EMBED_COLOR" \
                --arg footer "ì—…ë°ì´íŠ¸ ì¼ì •ì— ë”°ë¼ ì¶œí˜„ ì‹œê°„ì´ ë³€ê²½ ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤." \
                '{
                  content: $content,
                  embeds: [
                    {
                      title: $title,
                      description: $description,
                      color: $color,
                      footer: {text: $footer}
                    }
                  ]
                }')

              curl -H "Content-Type: application/json" \
                   -X POST \
                   -d "$PAYLOAD" \
                   ${{ secrets.DISCORD_WEBHOOK_URL }}
            else
              MESSAGE="âŒ ë‹¤ìŒ ì¶œí˜„ ì‹œê°„ì´ ì—†ìŒ."
              EMBED_TITLE="ì–´ë¹„ìŠ¤ ì •ë³´ ì—†ìŒ"
              EMBED_COLOR=7506394

              PAYLOAD=$(jq -n \
                --arg content "$MESSAGE" \
                --arg title "$EMBED_TITLE" \
                --arg description "ìˆ˜ë™ í™•ì¸ ì‹œê°: ${NOW_KST}" \
                --argjson color "$EMBED_COLOR" \
                --arg footer "ì¶”ì–µ ê¸¸ë“œ" \
                '{
                  content: $content,
                  embeds: [
                    {
                      title: $title,
                      description: $description,
                      color: $color,
                      footer: {text: $footer}
                    }
                  ]
                }')

              curl -H "Content-Type: application/json" \
                   -X POST \
                   -d "$PAYLOAD" \
                   ${{ secrets.DISCORD_WEBHOOK_URL }}
            fi
          fi
