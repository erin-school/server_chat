name: Discord Time Alerts

on:
  schedule:
    # ê¸°ì¡´ ê³ ì • ì•Œë¦¼ (KST ê¸°ì¤€)
    - cron: "49 * * * *"   # ë§¤ì‹œ 58ë¶„ (KST)
    - cron: "58 2 * * *"   # ì˜¤ì „ 11:58 KST
    - cron: "58 8 * * *"   # ì˜¤í›„ 5:58 KST
    - cron: "58 10 * * *"  # ì˜¤í›„ 7:58 KST
    - cron: "58 12 * * *"  # ì˜¤í›„ 9:58 KST
    # ìƒˆë¡œìš´ ê¸°ëŠ¥: ë§¤ë¶„ ì‹¤í–‰ (ì˜ˆìƒ ì¶œí˜„ ì‹œê°„ ìë™ ê°ì§€)
    - cron: "* * * * *"
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine which message to send (ê³ ì • ì‹œê°„ìš©)
        run: |
          HOUR=$(date -u +"%H")
          MINUTE=$(date -u +"%M")
          MESSAGE=""

          if [ "$HOUR" == "2" ] && [ "$MINUTE" == "58" ]; then
            MESSAGE="â° ì•„ ë§ë‹¤! í•„ë“œ ë³´ìŠ¤~!!! (ì˜¤ì „ 11:58)"
          elif [ "$HOUR" == "8" ] && [ "$MINUTE" == "58" ]; then
            MESSAGE="â° ì•„ ë§ë‹¤! í•„ë“œ ë³´ìŠ¤~!!! (ì˜¤í›„ 5:58)"
          elif [ "$HOUR" == "10" ] && [ "$MINUTE" == "58" ]; then
            MESSAGE="â° ì•„ ë§ë‹¤! í•„ë“œ ë³´ìŠ¤~!!! (ì˜¤í›„ 7:58)"
          elif [ "$HOUR" == "12" ] && [ "$MINUTE" == "58" ]; then
            MESSAGE="â° ì•„ ë§ë‹¤! í•„ë“œ ë³´ìŠ¤~!!! (ì˜¤í›„ 9:58)"
          fi

          if [ -n "$MESSAGE" ]; then
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{\"content\":\"$MESSAGE\"}" \
                 ${{ secrets.DISCORD_WEBHOOK_URL }}
          fi

      - name: Abyss spawn time check (ì˜ˆìƒ ì¶œí˜„ ìë™ ê°ì§€)
        run: |
          # í˜„ì¬ ì‹œê° (KST ê¸°ì¤€)
          NOW=$(date -d '+9 hours' '+%s')
          echo "í˜„ì¬ ì‹œê°„ (KST): $(date -d '@'$NOW)"

          # times.json íŒŒì¼ì— ì €ì¥ëœ ì˜ˆìƒ ì¶œí˜„ ì‹œê°„ ëª©ë¡ ì½ê¸°
          if [ ! -f "times.json" ]; then
            echo "âš ï¸ times.json íŒŒì¼ì´ ì—†ìŒ â€” ìŠ¤í‚µ"
            exit 0
          fi

          while read LINE; do
            # JSON ë°°ì—´ì˜ ê° í•­ëª© ì‹œê°„ ì½ê¸°
            TIME=$(echo $LINE | grep -oE '"[0-9T:+-]+"' | tr -d '"')
            [ -z "$TIME" ] && continue

            TARGET=$(date -d "$TIME" '+%s')
            ALERT=$((TARGET - 120))  # 2ë¶„ ì „

            DIFF=$((NOW - ALERT))
            if [ $DIFF -ge 0 ] && [ $DIFF -lt 60 ]; then
              echo "ğŸ”” ì–´ë¹„ìŠ¤ ì¶œí˜„ ì„ë°• ê°ì§€ ($TIME)"
              curl -H "Content-Type: application/json" \
                   -X POST \
                   -d "{\"content\":\"ğŸŒŒ ì–´ë¹„ìŠ¤ êµ¬ë© ì¶œí˜„ì´ì•¼! ($TIME ê¸°ì¤€)\"}" \
                   ${{ secrets.DISCORD_WEBHOOK_URL }}
            fi
          done < <(cat times.json)
