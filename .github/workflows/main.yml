name: Discord Hourly Alert (ê²°ê³„ ì•Œë¦¼)

on:
  schedule:
    # ë§¤ë¶„ ì‹¤í–‰ ìœ ì§€
    - cron: "* * * * *"
  workflow_dispatch:
  
jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - name: Send hourly alert
        run: |
          # KST ê¸°ì¤€ í˜„ì¬ ì‹œê°
          NOW_KST=$(TZ="Asia/Seoul" date '+%Y-%m-%d %H:%M:%S')
          KST_HOUR=$(TZ="Asia/Seoul" date '+%H')
          KST_MINUTE=$(TZ="Asia/Seoul" date '+%M')
          KST_SECOND=$(TZ="Asia/Seoul" date '+%S')

          # ìˆ˜ë©´ ì‹œê°„ 23~08ì‹œ ì œì™¸
          if [ "$KST_HOUR" -ge 23 ] || [ "$KST_HOUR" -lt 8 ]; then
            echo "ğŸ’¤ ìˆ˜ë©´ ì‹œê°„: ì•Œë¦¼ ìƒëµ (${KST_HOUR}:${KST_MINUTE})"
            exit 0
          fi

          # ê²°ê³„ ì‹œê°„ ë²”ìœ„: 58ë¶„~ë‹¤ìŒì‹œ 02ë¶„
          if [ "$KST_MINUTE" -ge 55 ] || [ "$KST_MINUTE" -le 2 ]; then
            MESSAGE="ğŸ’« ì—ë¦° ì„¸ê³„ì— ìƒˆë¡œìš´ ê²°ê³„ê°€ ìƒì„±ë˜ëŠ” ì¤‘ ì…ë‹ˆë‹¤. ìŠì§€ë§ê³  ì°¸ì—¬í•©ì‹œë‹¤!"
            EMBED_TITLE="ìƒˆë¡œìš´ ê²°ê³„ ê°ì§€ ë¨!!"
            EMBED_COLOR=7506394
          else
            # ë‹¤ìŒ ì •ê°ê¹Œì§€ ë‚¨ì€ ì‹œê°„ ê³„ì‚°
            MIN_LEFT=$((59 - 10#$KST_MINUTE))
            SEC_LEFT=$((60 - 10#$KST_SECOND))
            [ $SEC_LEFT -eq 60 ] && SEC_LEFT=0
            [ $MIN_LEFT -lt 0 ] && MIN_LEFT=0

            MESSAGE="â³ ì•„ì§ ê²°ê³„ê°€ ì—´ë¦¬ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ìŒ ê²°ê³„ê¹Œì§€ ë‚¨ì€ ì‹œê°„: ${MIN_LEFT}ë¶„ ${SEC_LEFT}ì´ˆ"
            EMBED_TITLE="ê²°ê³„ ëŒ€ê¸° ì¤‘"
            EMBED_COLOR=10181046
          fi

          # Embed payload ìƒì„±
          PAYLOAD=$(jq -n \
            --arg content "$MESSAGE" \
            --arg title "$EMBED_TITLE" \
            --arg description "í˜„ì¬ ì‹œê°: $NOW_KST" \
            --argjson color "$EMBED_COLOR" \
            --arg footer "í•´ë‹¹ ì•Œë¦¼ì€ ìˆ˜ë©´ ì‹œê°„ ë³´ì¥ì„ ìœ„í•´ ì €ë… 11ì‹œë¶€í„° ë‹¤ìŒë‚  8ì‹œê¹Œì§€ëŠ” ë°œì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤." \
            '{
              content: $content,
              embeds: [
                {
                  title: $title,
                  description: $description,
                  color: $color,
                  footer: {text: $footer}
                }
              ]
            }')

          # Discord Webhook ë°œì†¡
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "$PAYLOAD" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
