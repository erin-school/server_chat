name: Discord Hourly Alert (결계 알림)

on:
  schedule:
    - cron: "58-59,0-2 * * * *"  # 58~59분, 0~2분만 실행
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - name: Send hourly alert
        run: |
          # KST 기준 현재 시각
          NOW_KST=$(TZ="Asia/Seoul" date '+%Y-%m-%d %H:%M:%S')
          KST_HOUR=$(TZ="Asia/Seoul" date '+%H')
          KST_MINUTE=$(TZ="Asia/Seoul" date '+%M')
          KST_SECOND=$(TZ="Asia/Seoul" date '+%S')

          # 수면 시간 23~08시 제외
          if [ "$KST_HOUR" -ge 23 ] || [ "$KST_HOUR" -lt 8 ]; then
            echo "💤 수면 시간: 알림 생략 (${KST_HOUR}:${KST_MINUTE})"
            exit 0
          fi

          # 결계 시간 범위: 58분~다음시 02분
          if [ "$KST_MINUTE" -ge 58 ] || [ "$KST_MINUTE" -le 2 ]; then
            MESSAGE="💫 에린 세계에 새로운 결계가 생성되는 중 입니다. 잊지말고 참여합시다!"
            EMBED_TITLE="새로운 결계 감지 됨!!"
            EMBED_COLOR=7506394
          else
            # 아직 결계가 열리지 않음 → 다음 정시 58분까지 남은 시간 계산
            if [ "$KST_MINUTE" -lt 58 ]; then
              MIN_LEFT=$((58 - 10#$KST_MINUTE - 1))
              SEC_LEFT=$((60 - 10#$KST_SECOND))
            else
              # 02분 이후 → 다음 시간 결계까지 남은 시간
              MIN_LEFT=$((60 - 10#$KST_MINUTE + 58))
              SEC_LEFT=$((60 - 10#$KST_SECOND))
            fi
            [ $SEC_LEFT -eq 60 ] && SEC_LEFT=0
            [ $MIN_LEFT -lt 0 ] && MIN_LEFT=0

            MESSAGE="⏳ 아직 결계가 열리지 않았습니다.\n다음 결계까지 남은 시간: ${MIN_LEFT}분 ${SEC_LEFT}초"
            EMBED_TITLE="결계 대기 중"
            EMBED_COLOR=10181046
          fi

          # Embed payload 생성
          PAYLOAD=$(jq -n \
            --arg content "$MESSAGE" \
            --arg title "$EMBED_TITLE" \
            --arg description "현재 시각: $NOW_KST" \
            --argjson color "$EMBED_COLOR" \
            --arg footer "해당 알림은 수면 시간 보장을 위해 저녁 11시부터 다음날 8시까지는 발송되지 않습니다." \
            '{
              content: $content,
              embeds: [
                {
                  title: $title,
                  description: $description,
                  color: $color,
                  footer: {text: $footer}
                }
              ]
            }')

          # Discord Webhook 발송
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "$PAYLOAD" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
