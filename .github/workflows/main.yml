name: Discord Time Alerts (Accurate)

on:
  schedule:
    - cron: "*/1 * * * *"  # ë§¤ë¶„ ì‹¤í–‰
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - name: Send accurate alert
        run: |
          KST_HOUR=$(date -d '+9 hours' '+%H')
          KST_MINUTE=$(date -d '+9 hours' '+%M')
          KST_SECOND=$(date -d '+9 hours' '+%S')
          NOW_KST=$(date -d '+9 hours' '+%Y-%m-%d %H:%M:%S')

          echo "í˜„ì¬ ì‹œê°„ (KST): ${NOW_KST}"

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # âœ… ìˆ˜ë™ ì‹¤í–‰ì¼ ë•Œ â€” ë‹¤ìŒ ì •ì‹œê¹Œì§€ ë‚¨ì€ ì‹œê°„ ê³„ì‚°
            MIN_LEFT=$((60 - 10#$KST_MINUTE - 1))
            SEC_LEFT=$((60 - 10#$KST_SECOND))
            if [ $SEC_LEFT -eq 60 ]; then SEC_LEFT=0; fi
            if [ $MIN_LEFT -lt 0 ]; then MIN_LEFT=0; fi

            MESSAGE="ğŸ§­ í…ŒìŠ¤íŠ¸ ì‹¤í–‰! ë‹¤ìŒ ì •ì‹œê¹Œì§€ ë‚¨ì€ ì‹œê°„ì€ ì•½ ${MIN_LEFT}ë¶„ ${SEC_LEFT}ì´ˆì…ë‹ˆë‹¤."
            EMBED_TITLE="âŒ› ë‹¤ìŒ ì •ì‹œê¹Œì§€ ë‚¨ì€ ì‹œê°„"
            EMBED_COLOR=10181046

            PAYLOAD=$(jq -n \
              --arg content "$MESSAGE" \
              --arg title "$EMBED_TITLE" \
              --arg time "$NOW_KST" \
              --argjson color "$EMBED_COLOR" \
              '{
                content: $content,
                embeds: [
                  {
                    title: $title,
                    description: ("í˜„ì¬ ì‹œê°: " + $time),
                    color: $color,
                    footer: {text: "GitHub Actions í…ŒìŠ¤íŠ¸ ì‹¤í–‰"}
                  }
                ]
              }')

            echo "ğŸ’¬ í…ŒìŠ¤íŠ¸ ì•Œë¦¼ ì „ì†¡ ì¤‘..."
            curl -H "Content-Type: application/json" \
              -X POST \
              -d "$PAYLOAD" \
              ${{ secrets.DISCORD_WEBHOOK_URL }}

          else
            # â° ìë™ ëª¨ë“œ â€” ê¸°ì¡´ ì•Œë¦¼ ë¡œì§
            if [ "$KST_MINUTE" == "58" ]; then
              if [ "$KST_HOUR" == "11" ]; then
                MESSAGE="â° ì•„ ë§ë‹¤! í•„ë“œ ë³´ìŠ¤~!!! (ì˜¤ì „ 11:58)"
                EMBED_TITLE="ğŸŒ ì˜¤ì „ 11ì‹œ 58ë¶„"
                EMBED_COLOR=1127128
              elif [ "$KST_HOUR" == "17" ]; then
                MESSAGE="â° ì•„ ë§ë‹¤! í•„ë“œ ë³´ìŠ¤~!!! (ì˜¤í›„ 5:58)"
                EMBED_TITLE="ğŸŒ‡ ì˜¤í›„ 5ì‹œ 58ë¶„"
                EMBED_COLOR=14177041
              elif [ "$KST_HOUR" == "19" ]; then
                MESSAGE="â° ì•„ ë§ë‹¤! í•„ë“œ ë³´ìŠ¤~!!! (ì˜¤í›„ 7:58)"
                EMBED_TITLE="ğŸŒ† ì˜¤í›„ 7ì‹œ 58ë¶„"
                EMBED_COLOR=16753920
              elif [ "$KST_HOUR" == "21" ]; then
                MESSAGE="â° ì•„ ë§ë‹¤! í•„ë“œ ë³´ìŠ¤~!!! (ì˜¤í›„ 9:58)"
                EMBED_TITLE="ğŸŒ™ ì˜¤í›„ 9ì‹œ 58ë¶„"
                EMBED_COLOR=3447003
              else
                MESSAGE="â° ì•„ ë§ë‹¤! ê²°ê³„!"
                EMBED_TITLE="ğŸ’« ë§¤ì‹œ 58ë¶„ ì•Œë¦¼"
                EMBED_COLOR=7506394
              fi

              PAYLOAD=$(jq -n \
                --arg content "$MESSAGE" \
                --arg title1 "Meow!" \
                --argjson color1 1127128 \
                --arg title2 "Meow-meow!" \
                --argjson color2 14177041 \
                --arg alert_title "$EMBED_TITLE" \
                --argjson alert_color "$EMBED_COLOR" \
                '{
                  content: $content,
                  embeds: [
                    {title: $title1, color: $color1},
                    {title: $title2, color: $color2},
                    {title: $alert_title, color: $alert_color}
                  ]
                }')

              curl -H "Content-Type: application/json" \
                -X POST \
                -d "$PAYLOAD" \
                ${{ secrets.DISCORD_WEBHOOK_URL }}
            else
              echo "â³ ì•„ì§ ì•Œë¦¼ ì‹œê°ì´ ì•„ë‹˜ (${KST_HOUR}:${KST_MINUTE})"
            fi
          fi
