name: Notice

on:
  workflow_dispatch: {}  # 수동 실행 전용

jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Send notice embeds
        run: |
          # -------------------------------
          # 공지사항 배열 (제목|내용)
          # -------------------------------
          NOTICES=(
             "가을과 함께! 피크타임! 이벤트 안내  | https://mabinogimobile.nexon.com/News/Events/3192456"
              "만들고, 모으고, 꾸미고! 이벤트 안내 | https://mabinogimobile.nexon.com/News/Events/3212041"
           "꼬박꼬박 일일미션 이벤트 안내 | https://mabinogimobile.nexon.com/News/Events/3212042"
            "모험가 길드의 7일 특별 지원 & 집중 플레이 촉매 이벤트 안내  | https://mabinogimobile.nexon.com/News/Events/3212046"
          )

          EMBEDS_JSON="[ ]"

          for notice in "${NOTICES[@]}"; do
            TITLE=$(echo "$notice" | cut -d'|' -f1)
            DESCRIPTION=$(echo "$notice" | cut -d'|' -f2)

            # 줄바꿈 escape 처리
            ESCAPED_DESC=$(printf '%s' "$DESCRIPTION" | sed ':a;N;$!ba;s/\n/\\n/g')

            EMBED=$(jq -n \
              --arg title "$TITLE" \
              --arg description "$ESCAPED_DESC" \
              --arg footer "[공식] 이벤트" \
              --argjson color 16753920 \
              '{
                title: $title,
                description: $description,
                color: $color,
                footer: {text: $footer}
              }')

            # 배열에 추가
            EMBEDS_JSON=$(echo "$EMBEDS_JSON" | jq ". + [$EMBED]")
          done

          # 전체 payload 생성
          PAYLOAD=$(jq -n --argjson embeds "$EMBEDS_JSON" '{embeds: $embeds}')

          # Discord Webhook 전송
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$PAYLOAD" \
               "${{ secrets.DISCORD_WEBHOOK_URL_NOTICE }}"
