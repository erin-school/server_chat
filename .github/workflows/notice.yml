name: Notice

on:
  workflow_dispatch: {}  # 수동 실행 전용

jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Send notice embeds
        run: |
          # -------------------------------
          # 공지사항 배열 (제목|내용)
          # -------------------------------
          NOTICES=(
           "11/6(목) 신규 모험가 프리미엄 패스 | https://mabinogimobile.nexon.com/News/Notice/3212047"
            "11/6(목) 정기점검 안내 (06:00 ~ 11:00 | https://mabinogimobile.nexon.com/News/Notice/3212048"
          )

          EMBEDS_JSON="[ ]"

          for notice in "${NOTICES[@]}"; do
            TITLE=$(echo "$notice" | cut -d'|' -f1)
            DESCRIPTION=$(echo "$notice" | cut -d'|' -f2)

            # 줄바꿈 escape 처리
            ESCAPED_DESC=$(printf '%s' "$DESCRIPTION" | sed ':a;N;$!ba;s/\n/\\n/g')

            EMBED=$(jq -n \
              --arg title "$TITLE" \
              --arg description "$ESCAPED_DESC" \
              --arg footer "[공식] 확인 중인 현상" \
              --argjson color 16753920 \
              '{
                title: $title,
                description: $description,
                color: $color,
                footer: {text: $footer}
              }')

            # 배열에 추가
            EMBEDS_JSON=$(echo "$EMBEDS_JSON" | jq ". + [$EMBED]")
          done

          # 전체 payload 생성
          PAYLOAD=$(jq -n --argjson embeds "$EMBEDS_JSON" '{embeds: $embeds}')

          # Discord Webhook 전송
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$PAYLOAD" \
               "${{ secrets.DISCORD_WEBHOOK_URL_NOTICE }}"
