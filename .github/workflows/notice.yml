name: Abyss Alert

on:
  workflow_dispatch: {}  # 수동 실행 전용
  schedule:
    - cron: "0 12 * * 1"  # 예시: 매주 월요일 정오 실행

jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Send notice embed
        run: |
          TITLE="월요일 임시점검 안내"
          DESCRIPTION="마비노기 모바일 임시점검 안내드립니다."
          URL="https://mabinogimobile.nexon.com/News/Notice/3208255"
          FOOTER="점검"
          COLOR=16753920

          # 줄바꿈 escape 처리
          ESCAPED_DESC=$(printf '%s\n\n공지 링크: %s' "$DESCRIPTION" "$URL" | sed ':a;N;$!ba;s/\n/\\n/g')

          PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg description "$ESCAPED_DESC" \
            --argjson color "$COLOR" \
            --arg footer "$FOOTER" \
            '{
              embeds: [
                {
                  title: $title,
                  description: $description,
                  color: $color,
                  footer: {text: $footer}
                }
              ]
            }')

          # secrets 사용 시 반드시 따옴표로 감싸기
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "$PAYLOAD" \
               "${{ secrets.DISCORD_WEBHOOK_URL }}"
