name: Discord Boss Alert (보스 알림)

on:
  schedule:
    - cron: "* * * * *"  # 매분 실행
  workflow_dispatch:

jobs:
  send:
    runs-on: ubuntu-latest
    steps:
      - name: Send boss alert
        run: |
          # KST 기준 현재 시각
          NOW_KST=$(date -d '+9 hours' '+%Y-%m-%d %H:%M:%S')
          KST_HOUR=$(date -d '+9 hours' '+%H')
          KST_MINUTE=$(date -d '+9 hours' '+%M')

          # 수면 시간 23~08시 제외
          if [ "$KST_HOUR" -ge 23 ] || [ "$KST_HOUR" -lt 8 ]; then
            echo "💤 수면 시간: 알림 생략 (${KST_HOUR}:${KST_MINUTE})"
            exit 0
          fi

          # 메시지 발송 대상 시간 및 여유 체크
          SEND=false
          MESSAGE=""
          EMBED_COLOR=0

          case "$KST_HOUR" in
            "11") [ "$KST_MINUTE" -ge 55 ] && [ "$KST_MINUTE" -le 59 ] && SEND=true
                  MESSAGE="[⏰ 오전 12:00 보스 등장 전] 파밍을 위해 페리 매우 어려움, 토르모그 일반/어려움을 반드시 돌아야 합니다."
                  EMBED_COLOR=1127128 ;;
            "17") [ "$KST_MINUTE" -ge 55 ] && [ "$KST_MINUTE" -le 59 ] && SEND=true
                  MESSAGE="[⏰ 오후 18:00 보스 등장 전] 파밍을 위해 페리 매우 어려움, 토르모그 일반/어려움을 반드시 돌아야 합니다."
                  EMBED_COLOR=14177041 ;;
            "19") [ "$KST_MINUTE" -ge 55 ] && [ "$KST_MINUTE" -le 59 ] && SEND=true
                  MESSAGE="[⏰ 오후 20:00 보스 등장 전] 파밍을 위해 페리 매우 어려움, 토르모그 일반/어려움을 반드시 돌아야 합니다."
                  EMBED_COLOR=16753920 ;;
            "21") [ "$KST_MINUTE" -ge 55 ] && [ "$KST_MINUTE" -le 59 ] && SEND=true
                  MESSAGE="[⏰ 오후 22:00 보스 등장 전] 파밍을 위해 페리 매우 어려움, 토르모그 일반/어려움을 반드시 돌아야 합니다."
                  EMBED_COLOR=3447003 ;;
          esac

          # 정각 도달 시 보스 등장 메시지
          case "$KST_HOUR" in
            "12") [ "$KST_MINUTE" -eq 0 ] && SEND=true
                  MESSAGE="[🎉 정각 12:00] 보스가 등장했습니다! 참여하세요!"
                  EMBED_COLOR=1127128 ;;
            "18") [ "$KST_MINUTE" -eq 0 ] && SEND=true
                  MESSAGE="[🎉 정각 18:00] 보스가 등장했습니다! 참여하세요!"
                  EMBED_COLOR=14177041 ;;
            "20") [ "$KST_MINUTE" -eq 0 ] && SEND=true
                  MESSAGE="[🎉 정각 20:00] 보스가 등장했습니다! 참여하세요!"
                  EMBED_COLOR=16753920 ;;
            "22") [ "$KST_MINUTE" -eq 0 ] && SEND=true
                  MESSAGE="[🎉 정각 22:00] 보스가 등장했습니다! 참여하세요!"
                  EMBED_COLOR=3447003 ;;
          esac

          if [ "$SEND" = false ]; then
            echo "알림 대상 시간이 아님 (${KST_HOUR}:${KST_MINUTE})"
            exit 0
          fi

          EMBED_TITLE="필드 보스 알림"

          # Embed payload 생성
          PAYLOAD=$(jq -n \
            --arg content "$MESSAGE" \
            --arg title "$EMBED_TITLE" \
            --arg description "현재 시각: $NOW_KST" \
            --argjson color "$EMBED_COLOR" \
            --arg footer "해당 알림은 수면 시간 보장을 위해 저녁 11시부터 다음날 8시까지는 발송되지 않습니다." \
            '{
              content: $content,
              embeds: [
                {
                  title: $title,
                  description: $description,
                  color: $color,
                  footer: {text: $footer}
                }
              ]
            }')

          # Discord Webhook 발송
          curl -H "Content-Type: application/json" \
            -X POST \
            -d "$PAYLOAD" \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
